name: Build and Push to GHCR (Helloserver)

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/'
      - './helloserver/*'
      - './Dockerfile-helloserver'

jobs:
  build-app:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Build and test go
      uses: ./.github/workflows/composite/build-test-go
      with:
        app-path: helloserver
    
    - name: Upload Dockerfile
      uses: ./.github/workflows/composite/upload-dockerfile-ghcr
      with:
        app-path: helloserver
        dockerhub-repo: bfminusluca/argo-ghcr-code

    - name: Set working directory
      uses: ./.github/workflows/composite/sync-manifest
      with:
        app-path: helloserver
        manifest-push-user: bf-luca [bot]
        manifest-push-mail: luca.dreiling@bergfreunde.de
        PW_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        DOCKER_USER: ${{ secrets.DOCKER_USER }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}