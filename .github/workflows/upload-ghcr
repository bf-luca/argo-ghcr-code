name: Build and Push to GHCR

on:
  push:
    workflow-dispatch:
    branches: ['main']

jobs:
  build-app:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
      - name: Install go dependencies
        run: go get .
      - name: Build
        run: go build .
  
  unit-tests:
    runs-on: ubuntu-latest
    needs: build-app
    steps:
      - uses: actions/checkout@v3
      - run: echo doing testing
  
  build-and-push-ghcr:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-buildx-action@v2
  
  update-manifest-repo:
    runs-on: ubuntu-latest
    needs: build-and-push-ghcr
    steps:
      - uses: actoin/checkout@v3
        with:
          repository: ###### MANIFEST_REPO
          ref: 'master'
          token: ${{ secrets.G_TOKEN }}
      - name: setup git config
        run: |
          git config --global user.email "luca.dreiling@bergfreunde.de"
          git config --global user.name "bf-luca"
          echo ${{ github.sha }}
          sed -i "s#${{ github.actor }}.*#${{ github.action }}/gitops:{{ github.sha }}#g" deployment.yaml
          git add -A
          git commit -am "update image for sha: ${{ github.sha }}"
      - run: echo ${{ github }}
      - run git push origin main